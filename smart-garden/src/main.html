<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C21.20 Garden</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        .main-content {
            margin-top: 40px;
            max-width: 600px;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99999;
            backdrop-filter: blur(3px);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .loading-container {
            width: max-content;
            height: max-content;
            padding: 20px;
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0 0 0 / 25%);
        }

        .card {
            border-radius: 18px;
            border-width: 0;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        .form-switch input {
            height: 2em !important;
            width: 4em !important;
        }

        .form-switch label {
            margin-top: 3px !important;
            margin-left: 14px !important;
            font-size: 1.4em !important;
        }

        .form-range::-webkit-slider-runnable-track {
            background-color: transparent;
        }
        .form-range:disabled {
            visibility: hidden;
        }
    </style>
</head>

<body>

    <div class="d-none loading fade">
        <div class="loading-container">
            <span class="text-white fs-4 fade" id="notify-text"></span>
            <div class="spinner-border text-white" style="width: 80px; height: 80px;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="main-content col">

                <div class="card">
                    <div class="card-body text-muted fs-5 py-4">
                        <label for="valve-slider" class="form-label">Trạng thái: <span class="state-text">Đóng</span></label>
                        <div class="d-flex position-relative">
                            <span>Đóng</span>
                            <input type="range" class="form-range mt-1 ms-3 me-3" min="0" max="10" step="1" value="0" id="valve-slider" style="z-index: 1;">
                            <span>Mở</span>
                            <div class="progress" role="progressbar" style="position: absolute; top: 1em; left: 5.3em; right: 3.5em; height: 0.65em; z-index: 0;">
                                <div class="progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="collapse mt-4" id="valve-collapse">
                            <div class="d-flex">
                                <button class="btn btn-light w-100 me-4">Dừng</button>
                                <button class="btn btn-light w-100">Đóng</button>
                            </div>
                          </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="R1">
                            <label class="form-check-label" for="flexSwitchCheckDefault">R1</label>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="R2">
                            <label class="form-check-label" for="flexSwitchCheckDefault">R2</label>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="R3">
                            <label class="form-check-label" for="flexSwitchCheckDefault">R3</label>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="R4">
                            <label class="form-check-label" for="flexSwitchCheckDefault">R4</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        const LOADING = new class {
            constructor() {
                this.el = document.querySelector('.loading')
                this.spiner = this.el.querySelector('.spinner-border')
                this.text = this.el.querySelector('#notify-text')
                this.showDelay = null
                this.showCB = null
                this.hideDelay = null
            }
            show(timeout = 0, timeoutCB = null) {
                this.el.classList.remove('d-none')
                this.spiner.classList.remove('d-none')
                this.text.innerHTML = ''
                this.text.classList.remove('show')
                clearTimeout(this.showDelay)
                clearTimeout(this.showCB)
                clearTimeout(this.hideDelay)
                this.showDelay = setTimeout(() => this.el.classList.add('show'), 100)
                if (timeout) {
                    this.showCB = setTimeout(() => {
                        this.hide()
                        if (timeoutCB) timeoutCB()
                    }, timeout)
                }
            }
            hide() {
                this.el.classList.remove('show')
                clearTimeout(this.showDelay)
                clearTimeout(this.showCB)
                clearTimeout(this.hideDelay)
                this.hideDelay = setTimeout(() => this.el.classList.add('d-none'), 100)
            }
            setText(text, timeout = 0, timeoutCB = null) {
                this.show()
                this.text.innerHTML = text
                this.spiner.classList.add('d-none')
                this.text.classList.add('show')
                if (timeout) {
                    this.showCB = setTimeout(() => {
                        this.hide()
                        if (timeoutCB) timeoutCB()
                    }, timeout)
                }
            }
        }

        const Slider = new class {
            constructor() {
                this.slider = document.getElementById('valve-slider')
                this.progress = this.slider.parentElement.querySelector('.progress-bar')
                this.collapse = new bootstrap.Collapse('#valve-collapse', { toggle: false })
                this.text = this.slider.closest('.card').querySelector('.state-text')
                this.changeTimer = null
                this.progressTimer = null
                this.slider.setAttribute('last-value', this.slider.value)
                this.slider.addEventListener('change', (e) => this.setValue(e.target.value, 8000))
            }
            update(v) {
                this.slider.value = v
                this.progress.style.width = `${v * 10}%`
            }
            setValue(v, timeout = 0, timeoutCB = null) {
                let lVal = Number(this.slider.getAttribute('last-value'))
                const changeAmount = Number(v) - lVal
                let stateText = ''
                let step = 1
                if (!changeAmount) return
                
                clearTimeout(this.changeTimer)
                clearInterval(this.progressTimer)
                if (changeAmount < 0) {
                    stateText = 'Đang đóng'
                    step = -1
                } else {
                    stateText = 'Đang mở'
                }
                this.progress.innerHTML = stateText + '...'
                this.text.innerHTML = stateText + ' đến ' + v * 10 + '%'
                this.slider.disabled = true
                this.collapse.show()
                lVal += step
                this.update(lVal)
                this.progressTimer = setInterval(() => {
                    lVal += step
                    this.update(lVal)
                    if (lVal == v)
                        clearInterval(this.progressTimer)
                }, 800)
                if (timeout) {
                    this.changeTimer = setTimeout(() => {
                        this.slider.value = this.slider.getAttribute('last-value')
                        this.done()
                        LOADING.setText('Lỗi: không thể đóng/mở van', 2000)
                        if (timeoutCB) timeoutCB()
                    }, timeout)
                }
            }
            done() {
                const v = this.slider.value
                clearTimeout(this.changeTimer)
                clearInterval(this.progressTimer)
                this.collapse.hide()
                this.progress.innerHTML = ''
                this.slider.disabled = false
                this.slider.setAttribute('last-value', v)
                this.update(v)
                if (v == 0) {
                    this.text.innerHTML = 'Đóng'
                } else {
                    this.text.innerHTML = 'Mở ' + v * 10 + '%'
                }
            }
        }

        function setSwitchState(id, state) {
            document.getElementById(id).checked = state == 'ON'
        }
    </script>
    <!-- <script>
        var ws = new WebSocket(`ws://${location.host}/ws`);

        ws.onmessage = (e) => {
            LOADING.hide()
            const message = e.data
            console.log('[WS Received]', message)
            if (!message) return
            message.split('\n')
                .forEach(m => {
                    const match = m.match(/R\d{1}:(ON|OFF)/g)
                    if (match) {
                        const [id, state] = match[0].split(':')
                        setSwitchState(id, state)
                    }
                });
        }

        document.querySelectorAll('.form-switch input').forEach(i => {
            i.addEventListener('change', e => {
                console.log(e.target.id, e.target.checked)
                LOADING.show(2000, () => {
                    LOADING.setText('Lỗi: điều khiển thất bại', 2000)
                    e.target.checked = !e.target.checked
                })
                ws.send(`${e.target.id}:${e.target.checked ? 'ON' : 'OFF'}`)
            })
        })
    </script> -->
</body>

</html>